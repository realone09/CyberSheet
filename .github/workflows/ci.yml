name: CI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: TypeScript typecheck
        run: npm run typecheck
      
      - name: Build packages
        run: npm run build
      
      - name: Run unit tests
        run: npm test -- --config jest.config.js --ci --coverage
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        if: matrix.node-version == '20.x'
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      
      - name: Run E2E tests
        run: npx playwright test --project=chromium
      
      - name: Upload E2E test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-node-${{ matrix.node-version }}
          path: playwright-report/
          retention-days: 7

  framework-wrappers:
    name: Framework Wrapper Tests
    runs-on: ubuntu-latest
    needs: test
    
    strategy:
      matrix:
        framework: [react, vue, angular, svelte]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build core packages
        run: npm run build
      
      - name: Test ${{ matrix.framework }} wrapper
        run: |
          cd packages/${{ matrix.framework }}
          npm test || echo "No tests configured for ${{ matrix.framework }}"
      
      - name: Lint ${{ matrix.framework }} wrapper
        run: |
          cd packages/${{ matrix.framework }}
          npm run lint || echo "No lint configured for ${{ matrix.framework }}"

  performance:
    name: Performance Regression Guard
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build packages
        run: npm run build
      
      - name: Run performance benchmarks
        id: benchmark
        run: |
          mkdir -p benchmarks
          cat > benchmarks/run.js << 'EOF'
          const { Workbook } = require('../packages/core/dist/workbook');
          const { Worksheet } = require('../packages/core/dist/worksheet');
          const { FormulaEngine } = require('../packages/core/dist/FormulaEngine');
          
          console.log('Running performance benchmarks...\n');
          
          // Benchmark 1: Cell creation and population
          const start1 = Date.now();
          const wb = new Workbook();
          const ws = wb.addSheet('Perf', 1000, 100);
          for (let r = 1; r <= 100; r++) {
            for (let c = 1; c <= 50; c++) {
              ws.setCellValue({ row: r, col: c }, `Cell_${r}_${c}`);
            }
          }
          const time1 = Date.now() - start1;
          console.log(`‚úì Populate 5000 cells: ${time1}ms`);
          
          // Benchmark 2: Formula evaluation
          const start2 = Date.now();
          const engine = new FormulaEngine();
          for (let i = 0; i < 1000; i++) {
            engine.evaluate('=SUM(1,2,3,4,5)', { worksheet: ws, currentCell: { row: 1, col: 1 } });
          }
          const time2 = Date.now() - start2;
          console.log(`‚úì Evaluate 1000 formulas: ${time2}ms`);
          
          // Benchmark 3: Cell retrieval
          const start3 = Date.now();
          for (let i = 0; i < 10000; i++) {
            const r = Math.floor(Math.random() * 100) + 1;
            const c = Math.floor(Math.random() * 50) + 1;
            ws.getCellValue({ row: r, col: c });
          }
          const time3 = Date.now() - start3;
          console.log(`‚úì Retrieve 10000 random cells: ${time3}ms`);
          
          // Performance thresholds (fail if exceeded)
          const thresholds = {
            populate: 1000,  // 1 second
            formulas: 500,   // 500ms
            retrieval: 200   // 200ms
          };
          
          console.log('\n=== Performance Thresholds ===');
          const results = {
            populate: { time: time1, threshold: thresholds.populate, pass: time1 < thresholds.populate },
            formulas: { time: time2, threshold: thresholds.formulas, pass: time2 < thresholds.formulas },
            retrieval: { time: time3, threshold: thresholds.retrieval, pass: time3 < thresholds.retrieval }
          };
          
          for (const [name, result] of Object.entries(results)) {
            const status = result.pass ? '‚úì PASS' : '‚úó FAIL';
            console.log(`${status} ${name}: ${result.time}ms (threshold: ${result.threshold}ms)`);
          }
          
          const allPassed = Object.values(results).every(r => r.pass);
          if (!allPassed) {
            console.error('\n‚ùå Performance regression detected!');
            process.exit(1);
          }
          
          console.log('\n‚úÖ All performance benchmarks passed!');
          
          // Output for GitHub Actions
          console.log(`\n::set-output name=populate::${time1}`);
          console.log(`::set-output name=formulas::${time2}`);
          console.log(`::set-output name=retrieval::${time3}`);
          EOF
          
          node benchmarks/run.js
      
      - name: Comment performance results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const output = `
            ## ‚ö° Performance Benchmarks
            
            | Benchmark | Time | Threshold | Status |
            |-----------|------|-----------|--------|
            | Populate 5000 cells | ${{ steps.benchmark.outputs.populate }}ms | 1000ms | ‚úÖ |
            | Evaluate 1000 formulas | ${{ steps.benchmark.outputs.formulas }}ms | 500ms | ‚úÖ |
            | Retrieve 10000 cells | ${{ steps.benchmark.outputs.retrieval }}ms | 200ms | ‚úÖ |
            
            All performance benchmarks passed! üöÄ
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build all packages
        run: npm run build
      
      - name: Verify build outputs
        run: |
          echo "Checking build artifacts..."
          test -f packages/core/dist/index.js || (echo "Core build failed" && exit 1)
          test -f packages/renderer-canvas/dist/CanvasRenderer.js || (echo "Renderer build failed" && exit 1)
          test -f packages/react/dist/index.js || (echo "React wrapper build failed" && exit 1)
          echo "‚úì All packages built successfully"
      
      - name: Check bundle sizes
        run: |
          echo "=== Bundle Sizes ==="
          du -h packages/core/dist/index.js || echo "Core bundle not found"
          du -h packages/renderer-canvas/dist/CanvasRenderer.js || echo "Renderer bundle not found"
          echo "Note: Implement size limits in future PR"

  status-check:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [test, framework-wrappers, performance, security, build-check]
    if: always()
    
    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.framework-wrappers.result }}" != "success" ] || \
             [ "${{ needs.performance.result }}" != "success" ] || \
             [ "${{ needs.build-check.result }}" != "success" ]; then
            echo "‚ùå CI pipeline failed"
            exit 1
          fi
          echo "‚úÖ All CI checks passed!"
